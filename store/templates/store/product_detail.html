{% extends 'base.html' %}
{% load static %}
{% load cloudinary_extras %}

{% block content %} 

<div class="container py-5"> 
  <div class="row"> 
<!-- Left Column: Main Image + Thumbnails --> 
 <div class="col-md-6 d-flex"> 
  <div class="d-flex flex-column me-3" style="max-height: 500px; overflow-y: auto;"> 
    {% for variant in variants %} 
    {% for img in variant.all_images %} 
    <img src="{{ img.image|cloudinary_url:'w_100,h_100,c_fit' }}" 
    class="img-thumbnail mb-2 thumb" style="cursor: pointer;" onclick="switchVariant( '{{ img.image|cloudinary_url:'w_600,h_600,c_fit' }}', '{{ variant.price }}', '{{ variant.description|escapejs }}', '{{ variant.id }}' )" alt="Thumbnail for {{ variant.color_name }}" loading="lazy" > 
    {% endfor %} 
     {% endfor %}
  </div> 
  <!-- Main Image --> 
   <div class="flex-grow-1 text-center"> {% if variants and variants.0.image %} 
    <img id="main-image" src="{{ variants.0.image|cloudinary_url:'w_600,h_600,c_fit' }}" class="img-fluid rounded shadow" alt="{{ product.name }}" loading="lazy" > 
    {% else %} 
    <img id="main-image" src="{% static 'images/no-image.png' %}" class="img-fluid rounded shadow" alt="No image" loading="lazy" > 
    {% endif %} 
  </div> 
</div>

    <!-- Right Column: Product Details -->
    <div class="col-md-6">
      <h1 class="mb-3">{{ product.name }}</h1>

<!-- Color Swatch Selection -->
<div class="mb-4">
  <strong>Select Color:</strong>
  <div class="d-flex flex-wrap gap-2 mt-2">
    {% for variant in variants %}
      {% if variant.color_codes %}
<button 
  class="border rounded-circle" 
  style="
    width: 32px; 
    height: 32px; 
    background: {{ variant.swatch_background }};
    border: 2px solid #aaa;
  " 
  title="{{ variant.color_name }}" 
  onclick="switchVariant(
    {% if variant.image %}'{{ variant.image|cloudinary_url:'w_600,h_600,c_fit' }}'{% else %}''{% endif %},
    '{{ variant.price }}',
    '{{ variant.description|escapejs }}',
    '{{ variant.id }}'
  )"
></button>

      {% endif %}
    {% endfor %}
  </div>
</div>

      <!-- Price -->
      {% if variants and variants.0.price %}
        <h3 id="variant-price" class="text-success mb-4">£{{ variants.0.price }}</h3>
      {% else %}
        <h3 class="text-success mb-4">Price not available</h3>
      {% endif %}

      <!-- Description -->
      {% if variants.0.description %}
        <p id="variant-description" class="mb-4">{{ variants.0.description }}</p>
      {% endif %}

      <!-- Action Buttons -->
<div class="d-flex gap-3">
  <!-- Buy Now Form -->
  <form action="{% url 'buy_now' variants.0.id %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn btn-primary btn-sm">Buy it now</button>
  </form>

  <!-- Add to Basket Form -->
  <form action="{% url 'add_to_basket' variants.0.id %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn btn-outline-primary btn-sm">Add to Basket</button>
  </form>
</div>

        <form action="{% url 'add_to_wishlist' product.id %}" method="post" class="mt-2 d-inline-block">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-primary btn-sm w-auto">
            {% if request.user.is_authenticated and product.id in wishlist_ids %}
              ❤️ In Wishlist
            {% else %}
              ♡ Add to Wishlist
            {% endif %}
          </button>
        </form>
      </div>

      <a href="{% url 'shop' %}" class="btn btn-link mt-4">&larr; Back to Shop</a>
    </div>

  </div>
</div>

<a href="{% url 'add_review' product.id %}" class="btn btn-outline-primary">
  Leave a Review
</a>
<h4 class="mt-4">Reviews</h4>
{% for review in product.reviews.all %}
  <div class="border p-3 mb-2">
    <strong>{{ review.user.username }}</strong> 
    <span class="text-muted">rated {{ review.rating }}/5</span>
    <p>{{ review.comment }}</p>
  </div>
{% empty %}
  <p>No reviews yet. Be the first to share your thoughts.</p>
{% endfor %}

<script>
function switchVariant(imageUrl, price, description, variantId) {
  if (imageUrl) {
    document.getElementById('main-image').src = imageUrl;
  }
  if (price) {
    document.getElementById('variant-price').innerText = '£' + parseFloat(price).toFixed(2);
  }
  if (description) {
    document.getElementById('variant-description').innerText = description;
  }
  if (variantId) {
    document.getElementById('variant-id').value = variantId;
  }
}
</script>

{% endblock %}










